---
title: "Growth Curve and Mixed Models"
author: "Michael Clark"
date: '`r Sys.Date()`'
output:
  html_document:
    css: standard_html.css
    keep_md: yes
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, R.options=list(width=120), comment=NA)
```

# Intro

I wanted to compare latent growth curve (LGC) and mixed models for settings with low(ish) numbers of clusters.  As an example, having 50 individuals with measured at 4 time points each wouldn't cause many to think twice in the mixed model setting, while running a structural equation model with 50 individuals has never been recommended. Growth curve models are notably constrained SEM, as many parameters are fixed, which helps matters, but I wanted to investigate this further. 

# Setup

I put together some quick code for simulation (it hasn't really been inspected too thoroughly but seemed okay in initial tests). The parameters are as follows:

- Number of clusters: 10, 25, 50 
- Time points within cluster: 5, 10, 25
- Correlation of random effects: -.5 to .5 

Thus sample sizes range from the ridiculously small (10\*5 = 50 total observations) to fairly healthy (50\*25 = 1250 total). Random effects were drawn from a multivariate normal and had that exact correlation (i.e. there was no distribution for the correlation; using the <span class="pack">MASS</span> package with `empirical = TRUE`).  Fixed effects are 3 and .75 for the intercept and effect of 'time'. Variances of the random effects and residuals were `1.0`.  Note that the mixed model estimated residual variance separately for each time point as would be the default in the LGC model. Number of simulated data sets for each of the 45 settings is 500.

Growth curve models were estimated with the R package <span class="pack">lavaan</span>, the mixed models were estimated with <span class="pack">nlme</span> with `varIdent` weights argument.

# Results
I'm showing and summarizing the results here, but I've not checked them too closely yet.


## Parameter estimates
Bias here refers to the difference in the mean estimated parameter value vs. the true.

### Fixed effects
```{r loadResult}
# load('growthvsMixedResults.RData')
load('growthvsMixed_EstResults.RData')
library(tidyverse); library(DT)
```

Maybe slight issues with the smallest samples sizes for the intercept, but nothing worrisome.

```{r biasFE, }
biasFE_ML %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_Int, biasMM_Int, biasLGC_Time, biasMM_Time) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t'))
```


### Random effect variance
Both underestimate random effects variance at these settings, and more so with smaller overall sample sizes, but neither more than the other.  One must recall though that I've used maximum likelihood rather than restricted maximum likelihood

```{r biasRE}
biasRE_ML %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_Int, biasMM_Int, biasLGC_Time, biasMM_Time) %>% 
  round(3) %>%
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```


### Random effect correlation
With few time points (5, 10) and/or smaller number of clusters (10, 25), both generally seem to exhibit positive bias, maybe more so with LGC.

```{r biasREcor}
biasREcor_ML %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_corRE, biasMM_corRE) %>% 
  round(3) %>%  
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```


## Interval width
95% confidence intervals were taken as the quantiles of the simulation estimates.

### Fixed effects
General trend of narrower interval estimates for mixed models with smaller sample settings, and low number of clusters generally.

```{r widthFixed}
fixedEffects_ML %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth_Int, widthMixed_Int, widthGrowth_Time,
                        widthMixed_Time, mixedWidthMinusgrowthWidth_Int, mixedWidthMinusgrowthWidth_Time) %>% 
  round(3) %>%  
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```

### Random effect variance
General trend of narrower interval estimates for mixed models with smaller sample settings, and low number of clusters generally.

```{r widthRandom, fig.width=4}
randomEffects_ML %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth_Int, widthMixed_Int, widthGrowth_Time,
                         widthMixed_Time, mixedWidthMinusgrowthWidth_Int, mixedWidthMinusgrowthWidth_Time) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45)) # does not respect width in any fashion it would appear

```


### Random effect correlation

The actual interval estimates for LGC were not confined to [-1,1], and results are somewhat mixed until overall number of observations exceeds 100, where there is no preference between approaches.

```{r widthRandomCor}
randomEffectsCor_ML %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth, widthMixed, mixedWidthMinusgrowthWidth) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```

# Estimation issues

With the smaller sample sizes we run into numerous issues in estimation.  In typical SEM settings this may result in negative variance estimates or other problems.  With mixed models, estimation of a perfect correlation of random intercepts and slopes might similarly call for further diagnostic inspection.  In addition, we know mixed models are biased for variance estimates when using maximum likelihood with small samples. Most mixed models packages will default to restricted maximum likelihood (REML) which serves to counter this bias.

I've defined 'failure' as any run that resulted in a `NaN` for <span class="pack">lavaan</span>, or a perfect positive/negative correlation for <span class="pack">nlme</span>. The following shows the proportion of such failures, which are quite dramatic for the growth curve approach.

```{r estimationFailure}
data.frame(grid, 
           growthFailures = sapply(growthFailures, function(x) mean(c(x))),
           mixedFailures = sapply(mixedMLFailures, function(x) mean(c(x))),
           mixedREMLFailures = sapply(mixedREMLFailures, function(x) mean(c(x)))) %>% 
  arrange(desc(growthFailures)) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```



# Results Clean
Given the estimation issues, here are results for situations in which those did not exist, though this puts the estimation approaches on equal footing since the criterion is different.  In addition, I've chosen the REML estimates for mixed model results.  However, the differences become negligible with more observations, as we would expect.


## Parameter estimates

### Fixed effects


```{r biasFE_clean}
biasFE_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_Int, biasMM_Int, biasLGC_Time, biasMM_Time) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```


### Random effect variance
Both underestimate random effects variance at these settings, and more so with smaller overall sample sizes, but neither more than the other.

```{r biasRE_clean}
biasRE_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_Int, biasMM_Int, biasLGC_Time, biasMM_Time) %>% 
  round(3) %>%  
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```


### Random effect correlation

```{r biasREcor_clean}
biasREcor_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, biasLGC_corRE, biasMM_corRE) %>% 
  round(3) %>%  
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```


## Interval width
95% confidence intervals were taken as the quantiles of the simulation estimates.

### Fixed effects

```{r widthFixed_clean}
fixedEffects_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth_Int, widthMixed_Int, widthGrowth_Time,
                        widthMixed_Time, mixedWidthMinusgrowthWidth_Int, mixedWidthMinusgrowthWidth_Time) %>% 
  round(3) %>%  
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```

### Random effect variance
General trend of narrower interval estimates for mixed models with smaller sample settings, and low number of clusters generally.

```{r widthRandom_clean, fig.width=4}
randomEffects_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth_Int, widthMixed_Int, widthGrowth_Time,
                         widthMixed_Time, mixedWidthMinusgrowthWidth_Int, mixedWidthMinusgrowthWidth_Time) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45)) # does not respect width in any fashion it would appear
```


### Random effect correlation

```{r widthRandomCo_cleanr}
randomEffectsCor_REML_clean %>% 
  select(nClusters, nWithinCluster, corRE, widthGrowth, widthMixed, mixedWidthMinusgrowthWidth) %>% 
  round(3) %>% 
  datatable(rownames=F, options=list(dom='t', pageLength=45))
```

# Summary

Latent growth curve modeling and mixed models offer two ways to approach longitudinal data.  If set up properly with large amounts of data, they will result in identical estimates.  However, there are a few things against using LGC in my opinion. 

- LGC *requires* balanced data, and so one must estimate missing values as a default, or else risk losing a lot of data even with only minor missingness, and doing so can make postestimation procedures problematic depending on the imputation technique chosen. 
- LGC also requires four time points[^tp], but as the above demonstrates, success is not guaranteed with 5 time points even with 50 observations. 
- LGC is not very viable for small samples. On the other hand, one could run a repeated measures anova, a special case of the mixed model, on two timepoints and a handful of subjects without issue.
- Adding covariates to an LGC is tedious and causes the number of parameters to balloon quickly relative to the mixed model.

The purpose of this doc was to examine the failures at small sample sizes.  I typically tell people who are considering SEM that they shouldn't unless they have several hundred observations. Growth curve models are highly constrained SEM, and they *still* require a couple hundred observations even in the well-behaved data settings above.

LGC probably should not be run with very few time points, at least for these cluster sizes.  Both maximum likelihood approaches underestimate the random effects variance at these cluster sizes. Where there are differences which aren't in many of the tested situations, mixed models tend to have the preferable results.

# Future

Balanced vs not

Varying residual variance

vs. Bayesian mixed




# Code
[link](https://github.com/mclark--/Miscellaneous-R-Code/tree/master/SC%20and%20TR/mixedModels/growthCurvevsMixedModel.R)

[^tp]: Like other SEM it can be run with three with proper constraints.